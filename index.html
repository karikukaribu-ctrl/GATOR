<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>GARDES ‚Äî Console 3 Mois</title>

  <!-- =========================================================
    GARDES ‚Äî Interface ‚Äúaboutie‚Äù
    - Single-file (HTML/CSS/JS)
    - Pas de noms pr√©-enregistr√©s (tout est user-driven)
    - Vues : 3 mois calendrier + timeline + couverture
    - Jours f√©ri√©s BE (l√©gaux) toggle
    - Mi-temps color√©s (AM/PM)
    - Import/Export JSON (et export ICS minimal)
    - R√®gles (suggestions) : base extensible
    ========================================================= -->

  <!-- FullCalendar (calendar grid) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css">
  <!-- vis-timeline (timeline) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.3/styles/vis-timeline-graph2d.min.css">

  <style>
    :root{
      --bg:#0e1014;
      --panel:#151923;
      --panel2:#101521;
      --glass: rgba(255,255,255,.06);
      --glass2: rgba(255,255,255,.10);
      --fg:#e9edf6;
      --muted:#a8b0bf;
      --line: rgba(255,255,255,.10);
      --good:#7CFFB2;
      --warn:#FFD37C;
      --bad:#FF7CA3;

      --r:18px;
      --shadow: 0 18px 60px rgba(0,0,0,.55);

      /* types */
      --g1:#4aa3ff;      /* garde 1√®re ligne */
      --g2:#c38bff;      /* garde 2√®me ligne */
      --leave:#ff7c7c;   /* cong√© */
      --am:#61f0c6;      /* mi-temps AM */
      --pm:#ffcf6b;      /* mi-temps PM */
      --holiday:#b0b7ff; /* f√©ri√© */

      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --font2: ui-sans-serif, system-ui, -apple-system, "SF Pro Display","Segoe UI", Roboto, Helvetica, Arial;
    }

    [data-theme="light"]{
      --bg:#f4f6fb;
      --panel:#ffffff;
      --panel2:#ffffff;
      --glass: rgba(0,0,0,.04);
      --glass2: rgba(0,0,0,.06);
      --fg:#141826;
      --muted:#5b6477;
      --line: rgba(0,0,0,.10);
      --shadow: 0 18px 60px rgba(10, 20, 40, .12);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--font);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(74,163,255,.25), transparent 55%),
                  radial-gradient(900px 700px at 100% 0%, rgba(195,139,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 20% 110%, rgba(97,240,198,.12), transparent 55%),
                  var(--bg);
      color: var(--fg);
      overflow:hidden;
    }

    /* Layout */
    .app{
      display:grid;
      grid-template-columns: 360px 1fr;
      height:100%;
      gap: 14px;
      padding: 14px;
    }

    .left{
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 320px;
    }

    .main{
      background: linear-gradient(180deg, var(--glass2), var(--glass));
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-width: 0;
    }

    /* Left header */
    .leftTop{
      padding: 14px 14px 10px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand h1{
      margin:0;
      font-family: var(--font2);
      letter-spacing: .2px;
      font-weight: 780;
      font-size: 16px;
      line-height: 1.1;
    }
    .brand .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }

    .row{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--fg);
    }
    [data-theme="light"] .pill{ background: rgba(0,0,0,.03); }

    .pill b{ font-weight: 750; }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--fg);
      padding: 9px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      line-height: 1;
      transition: background .15s ease;
      user-select:none;
    }
    [data-theme="light"] .btn{ background: rgba(0,0,0,.03); }
    .btn:hover{ background: rgba(255,255,255,.06); }
    [data-theme="light"] .btn:hover{ background: rgba(0,0,0,.06); }

    .btn.primary{
      border-color: rgba(74,163,255,.55);
      background: rgba(74,163,255,.12);
    }
    .btn.danger{
      border-color: rgba(255,124,124,.55);
      background: rgba(255,124,124,.12);
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      color: var(--muted);
      user-select:none;
    }
    .toggle input{ accent-color: var(--g1); }

    .hr{
      height:1px; background: var(--line);
      margin: 10px 0;
    }

    /* Left content */
    .leftBody{
      padding: 12px 12px 14px 12px;
      overflow:auto;
    }

    .sectionTitle{
      margin: 10px 0 8px 0;
      font-size: 12px;
      letter-spacing:.5px;
      color: var(--muted);
      text-transform: uppercase;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    .card{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 12px;
      margin-bottom: 10px;
    }
    [data-theme="light"] .card{ background: rgba(0,0,0,.03); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    label{
      font-size: 11px;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      color: var(--fg);
      outline:none;
      font-size: 13px;
    }
    [data-theme="light"] input, [data-theme="light"] select, [data-theme="light"] textarea{
      background: rgba(255,255,255,.65);
      color: var(--fg);
    }
    textarea{ min-height: 74px; resize: vertical; }

    .personList{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .personItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 10px;
    }
    [data-theme="light"] .personItem{ background: rgba(0,0,0,.03); }

    .personLeft{
      display:flex; align-items:center; gap:10px;
      min-width:0;
    }
    .dot{
      width:12px; height:12px; border-radius:999px;
      background: var(--g1);
      box-shadow: 0 0 0 3px rgba(255,255,255,.06);
      flex: 0 0 auto;
    }
    .personName{
      font-weight: 700;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .personMeta{
      font-size: 12px;
      color: var(--muted);
      margin-top: 1px;
    }
    .mini{
      display:flex; flex-direction:column; min-width:0;
    }
    .iconBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--fg);
      width: 34px;
      height: 34px;
      border-radius: 12px;
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
    }
    [data-theme="light"] .iconBtn{ background: rgba(0,0,0,.03); }
    .iconBtn:hover{ background: rgba(255,255,255,.06); }
    [data-theme="light"] .iconBtn:hover{ background: rgba(0,0,0,.06); }

    /* Main header */
    .mainTop{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .tabs{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--fg);
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    [data-theme="light"] .tab{ background: rgba(0,0,0,.03); }
    .tab.active{
      border-color: rgba(74,163,255,.55);
      background: rgba(74,163,255,.12);
      font-weight: 750;
    }

    .mainBody{
      display:flex;
      flex: 1 1 auto;
      min-height:0;
      overflow:hidden;
    }

    .view{
      flex:1;
      min-width:0;
      display:none;
      overflow:auto;
      padding: 10px 10px 14px 10px;
    }
    .view.active{ display:block; }

    /* Calendar 3 months */
    .calGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(280px, 1fr));
      gap: 12px;
      align-items: start;
    }
    .calCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 10px;
      overflow:hidden;
    }
    [data-theme="light"] .calCard{ background: rgba(0,0,0,.03); }
    .calCard h3{
      margin:0 0 8px 0;
      font-size: 13px;
      color: var(--muted);
      font-weight: 750;
      letter-spacing:.2px;
    }

    /* FullCalendar tweaks */
    .fc{ font-size: 12px; }
    .fc .fc-toolbar{ display:none; }
    .fc .fc-daygrid-day-number{ color: var(--muted); }
    .fc .fc-col-header-cell-cushion{ color: var(--muted); font-weight:650; }
    .fc .fc-scrollgrid{ border-color: var(--line); }
    .fc-theme-standard td, .fc-theme-standard th{ border-color: var(--line); }
    .fc .fc-day-today{ background: rgba(97,240,198,.08) !important; }

    /* Timeline */
    #timeline{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      height: calc(100vh - 140px);
      min-height: 520px;
      overflow:hidden;
    }
    [data-theme="light"] #timeline{ background: rgba(0,0,0,.03); }

    /* Coverage table */
    .coverageWrap{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      overflow:hidden;
    }
    [data-theme="light"] .coverageWrap{ background: rgba(0,0,0,.03); }
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      border-bottom:1px solid var(--line);
      padding: 10px 10px;
      text-align:left;
      vertical-align: top;
    }
    th{
      color: var(--muted);
      font-weight: 750;
      background: rgba(255,255,255,.02);
    }
    [data-theme="light"] th{ background: rgba(0,0,0,.02); }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 5px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      margin: 2px 6px 2px 0;
      font-size: 12px;
      white-space:nowrap;
    }
    [data-theme="light"] .badge{ background: rgba(0,0,0,.03); }
    .sq{
      width:9px;height:9px;border-radius:3px;background:var(--g1);
    }

    /* Modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 9999;
    }
    .modalBackdrop.show{ display:flex; }
    .modal{
      width: min(920px, 98vw);
      max-height: 92vh;
      overflow:auto;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
    }
    [data-theme="light"] .modal{ background: var(--panel); }
    .modalTop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding: 14px 14px 10px 14px;
      border-bottom:1px solid var(--line);
    }
    .modalTop h2{
      margin:0;
      font-size: 14px;
      font-weight: 800;
    }
    .modalBody{
      padding: 12px 14px 14px 14px;
    }
    .help{
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
      margin: 0 0 10px 0;
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      align-items:start;
    }

    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .k{
      flex:1;
      min-width: 160px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 12px;
    }
    [data-theme="light"] .k{ background: rgba(0,0,0,.03); }
    .k .t{ font-size: 11px; color: var(--muted); }
    .k .v{ font-weight: 850; font-size: 16px; margin-top:4px; }

    .smallNote{
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      line-height: 1.35;
    }

    /* Responsive */
    @media (max-width: 1100px){
      .app{ grid-template-columns: 1fr; overflow:auto; }
      body{ overflow:auto; }
      .main{ min-height: 70vh; }
      .calGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body data-theme="dark">
  <div class="app">

    <!-- LEFT PANEL -->
    <aside class="left">
      <div class="leftTop">
        <div class="brand">
          <div>
            <h1>GARDES ‚Äî Console</h1>
            <div class="sub">3 mois ‚Ä¢ timeline ‚Ä¢ couverture ‚Ä¢ propositions</div>
          </div>
          <button class="iconBtn" id="btnTheme" title="Basculer th√®me">‚òº</button>
        </div>

        <div class="row">
          <span class="pill"><b id="kPersons">0</b> personnes</span>
          <span class="pill"><b id="kEvents">0</b> √©v√©nements</span>
          <span class="pill"><b id="kRange">‚Äî</b></span>
        </div>

        <div class="row">
          <button class="btn primary" id="btnAddEvent">+ Ajouter √©v√©nement</button>
          <button class="btn" id="btnPropose">Proposer</button>
          <button class="btn danger" id="btnReset">Reset</button>
        </div>

        <div class="row" style="justify-content:space-between;">
          <label class="toggle"><input type="checkbox" id="tglHolidays" checked> Afficher f√©ri√©s BE</label>
          <label class="toggle"><input type="checkbox" id="tglRecup" checked> Afficher r√©cup</label>
          <label class="toggle"><input type="checkbox" id="tglHalf" checked> Afficher mi-temps</label>
        </div>
      </div>

      <div class="leftBody">

        <div class="sectionTitle">
          <span>Personnes</span>
          <button class="btn" id="btnAddPerson">+ Ajouter</button>
        </div>

        <div class="card">
          <div class="grid2">
            <div>
              <label>Nom / Initiales</label>
              <input id="pLabel" placeholder="ex: C. Tahhan / J.-B. / A.">
            </div>
            <div>
              <label>Quotit√©</label>
              <select id="pQuota">
                <option value="1.0">Temps plein (1.0)</option>
                <option value="0.8">0.8</option>
                <option value="0.6">0.6</option>
                <option value="0.5">Mi-temps (0.5)</option>
              </select>
            </div>
            <div>
              <label>Couleur</label>
              <input id="pColor" type="color" value="#4aa3ff">
            </div>
            <div style="display:flex; align-items:end; gap:8px;">
              <button class="btn primary" id="btnSavePerson" style="width:100%;">Enregistrer</button>
            </div>
          </div>
          <div class="smallNote">
            Pas d‚Äôannuaire impos√©. Tu cr√©es, tu renommes, tu supprimes. Comme un dieu du planning (mais sans les √©clairs).
          </div>
        </div>

        <div class="personList" id="personList"></div>

        <div class="hr"></div>

        <div class="sectionTitle">
          <span>Import / Export</span>
        </div>
        <div class="card">
          <div class="row">
            <button class="btn" id="btnExportJSON">Exporter JSON</button>
            <button class="btn" id="btnImportJSON">Importer JSON</button>
            <button class="btn" id="btnExportICS">Exporter ICS</button>
          </div>
          <textarea id="ioBox" placeholder="Ici tu peux coller/voir un JSON. Import/Export en un clic."></textarea>
          <div class="smallNote">
            Import Excel : volontairement pas dans cette V1 single-file (sinon on ajoute SheetJS via CDN et c‚Äôest 2000 lignes de plus).
            Mais le format JSON est d√©j√† ‚ÄúExcel-friendly‚Äù √† g√©n√©rer.
          </div>
        </div>

        <div class="sectionTitle">
          <span>R√®gles (rappel)</span>
        </div>
        <div class="card">
          <div class="help">
            - Garde semaine 18h‚Äì9h (transmissions 8h20 urg, 8h30 UC) <br>
            - WE/f√©ri√© : 8‚Äì18 & 18‚Äì8 (transmission 8h/18h) <br>
            - 2√®me ligne : √† appeler sans h√©siter, obligatoire avant d√©cision d‚Äôexpertise <br>
            - Pas de 2√®me ligne si d√©j√† 1√®re ligne dans la semaine
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="mainTop">
        <div class="tabs">
          <div class="tab active" data-view="cal">Calendrier (3 mois)</div>
          <div class="tab" data-view="time">Timeline</div>
          <div class="tab" data-view="cover">Couverture</div>
        </div>
        <div class="row">
          <button class="btn" id="btnToday">Aujourd‚Äôhui</button>
          <button class="btn" id="btnPrev">‚óÄ</button>
          <button class="btn" id="btnNext">‚ñ∂</button>
          <span class="pill"><b id="rangeTitle">‚Äî</b></span>
        </div>
      </div>

      <div class="mainBody">
        <section class="view active" id="viewCal">
          <div class="calGrid">
            <div class="calCard"><h3 id="m1Title">Mois 1</h3><div id="cal1"></div></div>
            <div class="calCard"><h3 id="m2Title">Mois 2</h3><div id="cal2"></div></div>
            <div class="calCard"><h3 id="m3Title">Mois 3</h3><div id="cal3"></div></div>
          </div>
        </section>

        <section class="view" id="viewTime">
          <div id="timeline"></div>
        </section>

        <section class="view" id="viewCover">
          <div class="coverageWrap">
            <table>
              <thead>
                <tr>
                  <th style="width:120px;">Date</th>
                  <th>Garde 1√®re ligne</th>
                  <th>Garde 2√®me ligne</th>
                  <th>Cong√©s / Mi-temps / R√©cup / F√©ri√©</th>
                </tr>
              </thead>
              <tbody id="coverageBody"></tbody>
            </table>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- MODAL: Add event -->
  <div class="modalBackdrop" id="modalBack">
    <div class="modal">
      <div class="modalTop">
        <h2 id="modalTitle">Ajouter un √©v√©nement</h2>
        <button class="iconBtn" id="btnCloseModal" title="Fermer">‚úï</button>
      </div>
      <div class="modalBody">
        <p class="help">
          Tu ajoutes un bloc : garde (1L/2L), cong√©, mi-temps AM/PM, autre.
          Les f√©ri√©s BE sont g√©n√©r√©s automatiquement (toggle).
        </p>

        <div class="split">
          <div class="card">
            <div class="grid2">
              <div>
                <label>Type</label>
                <select id="eType">
                  <option value="g1_week">Garde 1√®re ligne ‚Äî Semaine nuit (18‚Äì9)</option>
                  <option value="g1_we_day">Garde 1√®re ligne ‚Äî WE/JF Jour (8‚Äì18)</option>
                  <option value="g1_we_night">Garde 1√®re ligne ‚Äî WE/JF Nuit (18‚Äì8)</option>

                  <option value="g2_week">Garde 2√®me ligne ‚Äî Semaine</option>
                  <option value="g2_weekend">Garde 2√®me ligne ‚Äî WE/JF</option>

                  <option value="leave">Cong√©</option>
                  <option value="half_am">Mi-temps AM (8h30‚Äì13h)</option>
                  <option value="half_pm">Mi-temps PM (13h45‚Äì18h15)</option>
                  <option value="note">Autre (note / formation)</option>
                </select>
              </div>
              <div>
                <label>Assign√© √†</label>
                <select id="ePerson"></select>
              </div>

              <div>
                <label>Date d√©but</label>
                <input type="date" id="eStart">
              </div>
              <div>
                <label>Date fin (optionnel)</label>
                <input type="date" id="eEnd">
              </div>

              <div style="grid-column: 1 / -1;">
                <label>Commentaire</label>
                <input id="eNote" placeholder="ex: expertise pr√©vue / r√©cup √† caler / etc.">
              </div>
            </div>

            <div class="row" style="margin-top:10px;">
              <button class="btn primary" id="btnSaveEvent">Enregistrer</button>
              <button class="btn" id="btnDeleteEvent" style="display:none;">Supprimer</button>
            </div>

            <div class="smallNote">
              Les gardes ‚Äúsemaine nuit‚Äù cr√©eront automatiquement un bloc ‚Äúr√©cup‚Äù le lendemain si le toggle R√©cup est activ√©.
              (Tu peux raffiner la r√®gle ensuite : vendredis, veilles f√©ri√©es, etc.)
            </div>
          </div>

          <div class="card">
            <div class="kpi">
              <div class="k"><div class="t">Propositions cong√©s</div><div class="v" id="kSugLeave">‚Äî</div></div>
              <div class="k"><div class="t">Propositions gardes</div><div class="v" id="kSugGuard">‚Äî</div></div>
            </div>
            <div class="hr"></div>
            <div class="help" id="suggestBox">
              Clique ‚ÄúProposer‚Äù dans la barre de gauche : tu auras une shortlist bas√©e sur une heuristique simple
              (√©viter veille/retour de garde, coller aux r√©cup, √©quilibrage minimal).
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vis-timeline@7.7.3/standalone/umd/vis-timeline-graph2d.min.js"></script>

  <script>
    /************************************************************
      State + persistence
    *************************************************************/
    const LS_KEY = "gardes_console_v1";
    const state = {
      persons: [],     // {id,label,quota,color}
      events: [],      // {id,type,personId,start,end,note,meta}
      viewStart: startOfMonth(new Date()),   // anchor for 3-month view
      settings: {
        theme: "dark",
        showHolidays: true,
        showRecup: true,
        showHalf: true
      }
    };

    function uid(prefix="id"){
      return prefix + "_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
    }

    function save(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      refreshKPIs();
    }

    function load(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return false;
      try{
        const obj = JSON.parse(raw);
        if(obj && typeof obj === "object"){
          Object.assign(state, obj);
          return true;
        }
      }catch(e){}
      return false;
    }

    function hardReset(){
      state.persons = [];
      state.events = [];
      state.viewStart = startOfMonth(new Date());
      state.settings = { theme:"dark", showHolidays:true, showRecup:true, showHalf:true };
      localStorage.removeItem(LS_KEY);
      applyTheme();
      applyTogglesFromState();
      renderAll();
    }

    /************************************************************
      Date helpers
    *************************************************************/
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toISODate(d){
      const dt = new Date(d);
      return dt.getFullYear()+"-"+pad2(dt.getMonth()+1)+"-"+pad2(dt.getDate());
    }
    function startOfMonth(d){
      const dt = new Date(d);
      return new Date(dt.getFullYear(), dt.getMonth(), 1);
    }
    function addMonths(d, n){
      const dt = new Date(d);
      return new Date(dt.getFullYear(), dt.getMonth()+n, 1);
    }
    function endOfMonth(d){
      const dt = new Date(d);
      return new Date(dt.getFullYear(), dt.getMonth()+1, 0);
    }
    function addDays(d, n){
      const dt = new Date(d);
      dt.setDate(dt.getDate()+n);
      return dt;
    }
    function sameDay(a,b){
      const A = new Date(a), B = new Date(b);
      return A.getFullYear()===B.getFullYear() && A.getMonth()===B.getMonth() && A.getDate()===B.getDate();
    }

    function frenchMonthTitle(d){
      return new Date(d).toLocaleDateString("fr-BE",{month:"long", year:"numeric"}).replace(/^\w/, c=>c.toUpperCase());
    }

    /************************************************************
      Belgian legal holidays (national) for a given year
      - Fixed: 1/1, 1/5, 21/7, 15/8, 1/11, 11/11, 25/12
      - Movable: Easter Monday, Ascension, Whit Monday
      NOTE: This is *legal holiday list*. ‚ÄúJour de remplacement‚Äù depends on employer/sector.
    *************************************************************/
    function easterDate(year){
      // Anonymous Gregorian algorithm (Meeus/Jones/Butcher)
      const a = year % 19;
      const b = Math.floor(year/100);
      const c = year % 100;
      const d = Math.floor(b/4);
      const e = b % 4;
      const f = Math.floor((b+8)/25);
      const g = Math.floor((b - f + 1)/3);
      const h = (19*a + b - d - g + 15) % 30;
      const i = Math.floor(c/4);
      const k = c % 4;
      const l = (32 + 2*e + 2*i - h - k) % 7;
      const m = Math.floor((a + 11*h + 22*l)/451);
      const month = Math.floor((h + l - 7*m + 114)/31); // 3=March,4=April
      const day = ((h + l - 7*m + 114) % 31) + 1;
      return new Date(year, month-1, day);
    }

    function belgianHolidays(year){
      const E = easterDate(year);
      const easterMonday = addDays(E, 1);
      const ascension = addDays(E, 39);
      const whitMonday = addDays(E, 50);

      const fixed = [
        { date: new Date(year,0,1), name:"Nouvel An" },
        { date: new Date(year,4,1), name:"F√™te du Travail" },
        { date: new Date(year,6,21), name:"F√™te nationale" },
        { date: new Date(year,7,15), name:"Assomption" },
        { date: new Date(year,10,1), name:"Toussaint" },
        { date: new Date(year,10,11), name:"Armistice" },
        { date: new Date(year,11,25), name:"No√´l" },
      ];
      const movable = [
        { date: easterMonday, name:"Lundi de P√¢ques" },
        { date: ascension, name:"Ascension" },
        { date: whitMonday, name:"Lundi de Pentec√¥te" },
      ];
      return fixed.concat(movable).sort((a,b)=>a.date-b.date);
    }

    /************************************************************
      Event styling + derived events
    *************************************************************/
    const TYPE_META = {
      g1_week:    { label:"G1 semaine (nuit)", colorVar:"--g1", kind:"guard", line:"G1" },
      g1_we_day:  { label:"G1 WE/JF (jour)",   colorVar:"--g1", kind:"guard", line:"G1" },
      g1_we_night:{ label:"G1 WE/JF (nuit)",   colorVar:"--g1", kind:"guard", line:"G1" },

      g2_week:    { label:"G2 semaine",        colorVar:"--g2", kind:"guard", line:"G2" },
      g2_weekend: { label:"G2 WE/JF",          colorVar:"--g2", kind:"guard", line:"G2" },

      leave:      { label:"Cong√©",             colorVar:"--leave", kind:"leave" },

      half_am:    { label:"Mi-temps AM",       colorVar:"--am", kind:"half" },
      half_pm:    { label:"Mi-temps PM",       colorVar:"--pm", kind:"half" },

      note:       { label:"Note / formation",  colorVar:"--muted", kind:"note" },

      holiday:    { label:"F√©ri√© l√©gal BE",    colorVar:"--holiday", kind:"holiday", system:true },
      recup:      { label:"R√©cup (auto)",      colorVar:"--good", kind:"recup", system:true },
    };

    function cssVar(name){ return getComputedStyle(document.body).getPropertyValue(name).trim(); }

    function personById(id){ return state.persons.find(p=>p.id===id) || null; }

    function normalizeEvent(e){
      // Ensure end exists for all-day usage. FullCalendar treats end as exclusive.
      const start = new Date(e.start);
      let end = e.end ? new Date(e.end) : new Date(e.start);
      // If end is same day, keep single day event -> end exclusive next day for calendar blocks.
      if (sameDay(start, end)) end = addDays(end, 1);
      return {...e, start: toISODate(start), end: toISODate(end)};
    }

    function derivedSystemEvents(){
      const sys = [];

      // Holidays across the 3-month window (plus buffer)
      const start = state.viewStart;
      const end = endOfMonth(addMonths(state.viewStart, 2));
      const years = new Set([start.getFullYear(), end.getFullYear()]);
      if(state.settings.showHolidays){
        years.forEach(y=>{
          belgianHolidays(y).forEach(h=>{
            if(h.date >= addDays(start,-7) && h.date <= addDays(end,7)){
              sys.push({
                id: "hol_"+toISODate(h.date),
                type:"holiday",
                personId:null,
                start: toISODate(h.date),
                end: toISODate(addDays(h.date,1)),
                note: h.name,
                meta:{ name:h.name }
              });
            }
          });
        });
      }

      // Recup: for g1_week (nuit) + g1_we_night -> next day
      if(state.settings.showRecup){
        state.events.forEach(ev=>{
          if(ev.type === "g1_week" || ev.type === "g1_we_night"){
            const sd = new Date(ev.start);
            const rec = addDays(sd, 1);
            sys.push({
              id: "rec_"+ev.id,
              type:"recup",
              personId: ev.personId,
              start: toISODate(rec),
              end: toISODate(addDays(rec,1)),
              note: "R√©cup (auto)",
              meta:{ source: ev.id }
            });
          }
        });
      }

      // Hide half-times if toggle off
      // (handled by filtering base events in buildDisplayEvents)

      return sys;
    }

    function buildDisplayEvents(){
      // base + derived system events
      const base = state.events
        .map(normalizeEvent)
        .filter(ev=>{
          if(!state.settings.showHalf && (ev.type==="half_am" || ev.type==="half_pm")) return false;
          return true;
        });

      const sys = derivedSystemEvents().map(normalizeEvent);

      return base.concat(sys);
    }

    /************************************************************
      Rendering: people list + calendars + timeline + coverage
    *************************************************************/
    const els = {};
    function cacheEls(){
      [
        "personList","btnSavePerson","pLabel","pQuota","pColor","kPersons","kEvents","kRange",
        "btnAddEvent","modalBack","btnCloseModal","eType","ePerson","eStart","eEnd","eNote",
        "btnSaveEvent","btnDeleteEvent","modalTitle","btnAddPerson","btnReset",
        "btnExportJSON","btnImportJSON","btnExportICS","ioBox",
        "btnTheme","tglHolidays","tglRecup","tglHalf",
        "btnToday","btnPrev","btnNext","rangeTitle","m1Title","m2Title","m3Title",
        "coverageBody","btnPropose","kSugLeave","kSugGuard","suggestBox"
      ].forEach(id=>els[id]=document.getElementById(id));

      // tabs
      document.querySelectorAll(".tab").forEach(t=>{
        t.addEventListener("click", ()=>{
          document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
          t.classList.add("active");
          const v = t.getAttribute("data-view");
          setView(v);
        });
      });
    }

    function applyTheme(){
      document.body.setAttribute("data-theme", state.settings.theme);
      els.btnTheme.textContent = (state.settings.theme==="dark") ? "‚òº" : "‚òæ";
      // re-render visuals (colors)
      renderAll();
    }

    function applyTogglesFromState(){
      els.tglHolidays.checked = !!state.settings.showHolidays;
      els.tglRecup.checked = !!state.settings.showRecup;
      els.tglHalf.checked = !!state.settings.showHalf;
    }

    function refreshKPIs(){
      els.kPersons.textContent = state.persons.length;
      els.kEvents.textContent = state.events.length;
      const start = state.viewStart;
      const end = endOfMonth(addMonths(state.viewStart, 2));
      els.kRange.textContent = `${toISODate(start)} ‚Üí ${toISODate(end)}`;
      els.rangeTitle.textContent = `${frenchMonthTitle(start)} ‚Äî ${frenchMonthTitle(end)}`;
      const title = `${frenchMonthTitle(start)} ‚Üí ${frenchMonthTitle(end)}`;
      els.rangeTitle.textContent = title;
    }

    function renderPeople(){
      const wrap = els.personList;
      wrap.innerHTML = "";

      state.persons.forEach(p=>{
        const div = document.createElement("div");
        div.className = "personItem";
        div.innerHTML = `
          <div class="personLeft">
            <div class="dot" style="background:${p.color}"></div>
            <div class="mini">
              <div class="personName">${escapeHtml(p.label)}</div>
              <div class="personMeta">Quotit√©: ${p.quota}</div>
            </div>
          </div>
          <div class="row" style="gap:6px;">
            <button class="iconBtn" title="Filtrer sur cette personne" data-act="filter">‚ü°</button>
            <button class="iconBtn" title="√âditer" data-act="edit">‚úé</button>
            <button class="iconBtn" title="Supprimer" data-act="del">üóë</button>
          </div>
        `;
        div.querySelector('[data-act="del"]').addEventListener("click", ()=>{
          if(!confirm(`Supprimer ${p.label} ? (√âv√©nements associ√©s conserv√©s, mais non assign√©s)`)) return;
          // Unassign events
          state.events = state.events.map(ev=> ev.personId===p.id ? {...ev, personId:null} : ev);
          state.persons = state.persons.filter(x=>x.id!==p.id);
          save();
          renderAll();
        });
        div.querySelector('[data-act="edit"]').addEventListener("click", ()=>{
          els.pLabel.value = p.label;
          els.pQuota.value = String(p.quota);
          els.pColor.value = p.color;
          els.btnSavePerson.textContent = "Mettre √† jour";
          els.btnSavePerson.dataset.editId = p.id;
        });
        div.querySelector('[data-act="filter"]').addEventListener("click", ()=>{
          // simple filter: open modal add event preselect person
          openEventModal(null, p.id);
        });

        wrap.appendChild(div);
      });

      // Update person select in event modal
      fillPersonSelect();
    }

    let cals = { cal1:null, cal2:null, cal3:null };
    function destroyCalendars(){
      Object.values(cals).forEach(cal=>{ if(cal) cal.destroy(); });
      cals = { cal1:null, cal2:null, cal3:null };
    }

    function calendarEventsForMonth(monthStart){
      const display = buildDisplayEvents();
      const start = startOfMonth(monthStart);
      const end = endOfMonth(monthStart);

      return display.filter(ev=>{
        const s = new Date(ev.start);
        const e = new Date(ev.end);
        // overlap with [start,end]
        return e >= start && s <= addDays(end,1);
      }).map(ev=>{
        const meta = TYPE_META[ev.type] || {label: ev.type, colorVar:"--muted"};
        const p = ev.personId ? personById(ev.personId) : null;
        const color = meta.colorVar.startsWith("--") ? cssVar(meta.colorVar) : meta.colorVar;
        const title = `${meta.label}${p ? " ‚Äî "+p.label : ""}${ev.note ? " ‚Ä¢ "+ev.note : ""}`;
        return {
          id: ev.id,
          start: ev.start,
          end: ev.end,
          title,
          allDay:true,
          backgroundColor: color,
          borderColor: "transparent",
          textColor: state.settings.theme==="dark" ? "#0b0d12" : "#101521",
          extendedProps: { raw: ev }
        };
      });
    }

    function renderCalendars(){
      destroyCalendars();

      const m1 = state.viewStart;
      const m2 = addMonths(m1,1);
      const m3 = addMonths(m1,2);

      els.m1Title.textContent = frenchMonthTitle(m1);
      els.m2Title.textContent = frenchMonthTitle(m2);
      els.m3Title.textContent = frenchMonthTitle(m3);

      const common = {
        initialView: "dayGridMonth",
        height: "auto",
        locale: "fr",
        firstDay: 1,
        dayMaxEvents: 3,
        fixedWeekCount: false,
        eventClick: (info)=>{
          const raw = info.event.extendedProps.raw;
          // ignore system holiday click editing? allow view-only
          openEventModal(raw);
        },
        dateClick: (info)=>{
          // quick add event on a day
          openEventModal({ start: info.dateStr, end: info.dateStr }, null, true);
        }
      };

      cals.cal1 = new FullCalendar.Calendar(document.getElementById("cal1"), {
        ...common,
        initialDate: toISODate(m1),
        events: calendarEventsForMonth(m1),
      });
      cals.cal2 = new FullCalendar.Calendar(document.getElementById("cal2"), {
        ...common,
        initialDate: toISODate(m2),
        events: calendarEventsForMonth(m2),
      });
      cals.cal3 = new FullCalendar.Calendar(document.getElementById("cal3"), {
        ...common,
        initialDate: toISODate(m3),
        events: calendarEventsForMonth(m3),
      });

      cals.cal1.render(); cals.cal2.render(); cals.cal3.render();
    }

    // Timeline
    let timeline = null;
    function renderTimeline(){
      const container = document.getElementById("timeline");
      container.innerHTML = "";

      const start = state.viewStart;
      const end = endOfMonth(addMonths(start,2));

      // groups = persons + "Non assign√©"
      const groups = new vis.DataSet();
      groups.add({ id:"unassigned", content:"Non assign√©" });
      state.persons.forEach(p=>{
        groups.add({ id:p.id, content: escapeHtml(p.label) });
      });

      const items = new vis.DataSet();
      const display = buildDisplayEvents();

      display.forEach(ev=>{
        const meta = TYPE_META[ev.type] || {label: ev.type, colorVar:"--muted"};
        const p = ev.personId ? personById(ev.personId) : null;
        const group = ev.personId || "unassigned";
        const color = meta.colorVar.startsWith("--") ? cssVar(meta.colorVar) : meta.colorVar;
        const label = `${meta.label}${p ? " ‚Äî "+p.label : ""}${ev.note ? " ‚Ä¢ "+ev.note : ""}`;

        items.add({
          id: ev.id,
          group,
          start: ev.start,
          end: ev.end,
          content: escapeHtml(label),
          style: `background:${color}; border:none; color:${state.settings.theme==="dark" ? "#0b0d12" : "#101521"}; border-radius:12px; padding:6px 8px;`,
          title: escapeHtml(label)
        });
      });

      timeline = new vis.Timeline(container, items, groups, {
        start: toISODate(addDays(start,-3)),
        end: toISODate(addDays(end,3)),
        zoomMin: 1000 * 60 * 60 * 24 * 3,        // 3 days
        zoomMax: 1000 * 60 * 60 * 24 * 120,      // 120 days
        stack: true,
        verticalScroll: true,
        maxHeight: "100%",
        margin: { item: 10, axis: 12 },
      });

      timeline.on("select", (props)=>{
        if(!props.items || !props.items.length) return;
        const id = props.items[0];
        const ev = buildDisplayEvents().find(x=>x.id===id);
        if(ev) openEventModal(ev);
      });
    }

    // Coverage
    function renderCoverage(){
      const body = els.coverageBody;
      body.innerHTML = "";

      const start = state.viewStart;
      const end = endOfMonth(addMonths(start,2));
      const display = buildDisplayEvents();

      // index by date
      const days = [];
      for(let d=new Date(start); d<=end; d=addDays(d,1)) days.push(new Date(d));

      const byDate = new Map(); // yyyy-mm-dd -> events[]
      display.forEach(ev=>{
        // distribute across days for all-day blocks
        const s = new Date(ev.start);
        const e = new Date(ev.end);
        for(let d=new Date(s); d<e; d=addDays(d,1)){
          const k = toISODate(d);
          if(!byDate.has(k)) byDate.set(k, []);
          byDate.get(k).push(ev);
        }
      });

      days.forEach(d=>{
        const k = toISODate(d);
        const list = (byDate.get(k) || []).slice();

        const g1 = list.filter(x=> (TYPE_META[x.type]?.line==="G1"));
        const g2 = list.filter(x=> (TYPE_META[x.type]?.line==="G2"));
        const other = list.filter(x=> !g1.includes(x) && !g2.includes(x));

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><b>${d.toLocaleDateString("fr-BE",{weekday:"short", day:"2-digit", month:"2-digit"})}</b><div style="color:var(--muted); font-size:11px;">${k}</div></td>
          <td>${renderBadges(g1)}</td>
          <td>${renderBadges(g2)}</td>
          <td>${renderBadges(other)}</td>
        `;
        body.appendChild(tr);
      });
    }

    function renderBadges(items){
      if(!items.length) return `<span style="color:var(--muted);">‚Äî</span>`;
      return items.map(ev=>{
        const meta = TYPE_META[ev.type] || {label: ev.type, colorVar:"--muted"};
        const p = ev.personId ? personById(ev.personId) : null;
        const color = meta.colorVar.startsWith("--") ? cssVar(meta.colorVar) : meta.colorVar;
        const txt = `${meta.label}${p ? " ‚Äî "+p.label : ""}${ev.note ? " ‚Ä¢ "+ev.note : ""}`;
        return `<span class="badge"><span class="sq" style="background:${color}"></span>${escapeHtml(txt)}</span>`;
      }).join("");
    }

    function renderAll(){
      refreshKPIs();
      renderPeople();
      renderCalendars();
      renderTimeline();
      renderCoverage();
      fillPersonSelect();
      refreshRangeTitles();
    }

    function refreshRangeTitles(){
      const start = state.viewStart;
      const end = endOfMonth(addMonths(start,2));
      els.kRange.textContent = `${toISODate(start)} ‚Üí ${toISODate(end)}`;
      els.rangeTitle.textContent = `${frenchMonthTitle(start)} ‚Äî ${frenchMonthTitle(end)}`;
    }

    /************************************************************
      Modal: add/edit event
    *************************************************************/
    let editingEventId = null;

    function fillPersonSelect(){
      const sel = els.ePerson;
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "‚Äî Non assign√© ‚Äî";
      sel.appendChild(opt0);

      state.persons.forEach(p=>{
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.label;
        sel.appendChild(opt);
      });
    }

    function openEventModal(ev=null, forcePersonId=null, dateClick=false){
      editingEventId = null;
      els.btnDeleteEvent.style.display = "none";

      // Protect system events: allow view-only
      const isSystem = ev && TYPE_META[ev.type]?.system;

      if(ev && ev.id){
        editingEventId = ev.id;
        els.modalTitle.textContent = isSystem ? "Voir √©v√©nement syst√®me" : "Modifier √©v√©nement";
        els.btnDeleteEvent.style.display = (!isSystem && !ev.id.startsWith("hol_") && !ev.id.startsWith("rec_")) ? "inline-block" : "none";
      }else{
        els.modalTitle.textContent = dateClick ? "Ajouter √©v√©nement (jour s√©lectionn√©)" : "Ajouter un √©v√©nement";
      }

      // Defaults
      const today = toISODate(new Date());
      els.eType.value = ev?.type && !isSystem ? ev.type : "g1_week";
      els.eStart.value = ev?.start ? ev.start : (ev?.start ? ev.start : today);
      els.eEnd.value = ev?.end && !sameDay(new Date(ev.start), new Date(addDays(new Date(ev.end),-1))) ? ev.end : ""; // keep empty for single day
      els.eNote.value = ev?.note || "";

      // Person
      fillPersonSelect();
      if(forcePersonId) els.ePerson.value = forcePersonId;
      else els.ePerson.value = ev?.personId || "";

      // Disable editing for system events
      [els.eType, els.ePerson, els.eStart, els.eEnd, els.eNote, els.btnSaveEvent].forEach(x=> x.disabled = !!isSystem);
      if(isSystem) els.btnSaveEvent.textContent = "OK";
      else els.btnSaveEvent.textContent = editingEventId ? "Mettre √† jour" : "Enregistrer";

      els.modalBack.classList.add("show");
    }

    function closeModal(){
      els.modalBack.classList.remove("show");
      editingEventId = null;
    }

    function saveEventFromModal(){
      // If modal is in system view-only mode, close
      if(els.btnSaveEvent.disabled){
        closeModal();
        return;
      }

      const type = els.eType.value;
      const personId = els.ePerson.value || null;
      const start = els.eStart.value;
      let end = els.eEnd.value || start;
      const note = els.eNote.value.trim();

      if(!start){
        alert("Date d√©but manquante.");
        return;
      }

      const base = {
        type, personId, start, end, note,
        meta: {}
      };

      if(editingEventId){
        state.events = state.events.map(ev=> ev.id===editingEventId ? {...ev, ...base} : ev);
      }else{
        state.events.push({ id: uid("ev"), ...base });
      }

      save();
      renderAll();
      closeModal();
    }

    function deleteEvent(){
      if(!editingEventId) return;
      if(!confirm("Supprimer cet √©v√©nement ?")) return;
      state.events = state.events.filter(ev=>ev.id!==editingEventId);
      save();
      renderAll();
      closeModal();
    }

    /************************************************************
      People add/update
    *************************************************************/
    function savePerson(){
      const label = (els.pLabel.value || "").trim();
      if(!label){
        alert("Nom/initiales manquants.");
        return;
      }
      const quota = parseFloat(els.pQuota.value);
      const color = els.pColor.value;

      const editId = els.btnSavePerson.dataset.editId || null;
      if(editId){
        state.persons = state.persons.map(p=> p.id===editId ? {...p, label, quota, color} : p);
        delete els.btnSavePerson.dataset.editId;
        els.btnSavePerson.textContent = "Enregistrer";
      }else{
        state.persons.push({ id: uid("p"), label, quota, color });
      }

      els.pLabel.value = "";
      els.pQuota.value = "1.0";
      els.pColor.value = "#4aa3ff";

      save();
      renderAll();
    }

    /************************************************************
      Navigation (3 months)
    *************************************************************/
    function goToday(){
      state.viewStart = startOfMonth(new Date());
      save();
      renderAll();
    }
    function goPrev(){
      state.viewStart = addMonths(state.viewStart, -1);
      save();
      renderAll();
    }
    function goNext(){
      state.viewStart = addMonths(state.viewStart, +1);
      save();
      renderAll();
    }

    /************************************************************
      Suggestions (heuristique simple mais utile)
      - Proposer cong√©s autour de r√©cup + √©viter veille de garde
      - Proposer candidats de garde : ceux avec moins de charges (ici: nb de gardes sur fen√™tre)
    *************************************************************/
    function getWindowDates(){
      const start = state.viewStart;
      const end = endOfMonth(addMonths(start,2));
      return { start, end };
    }

    function eventsForPerson(personId){
      return state.events.filter(e=>e.personId===personId);
    }

    function dayHasType(dateISO, type){
      const disp = buildDisplayEvents();
      return disp.some(ev=> ev.type===type && overlapsDay(ev, dateISO));
    }

    function overlapsDay(ev, dateISO){
      const d = new Date(dateISO);
      const s = new Date(ev.start);
      const e = new Date(ev.end);
      return d >= s && d < e;
    }

    function listDayEvents(dateISO){
      const disp = buildDisplayEvents();
      return disp.filter(ev=>overlapsDay(ev, dateISO));
    }

    function propose(){
      // Minimal suggestions: pick a date (today) and propose leave days + guard candidates
      const todayISO = toISODate(new Date());
      const {start, end} = getWindowDates();

      // pick focus date = today if in window else window start
      const focus = (new Date(todayISO) >= start && new Date(todayISO) <= end) ? todayISO : toISODate(start);

      // leave suggestions for each person: 3 best days in next 14 days
      const horizon = 14;
      const days = [];
      for(let i=0;i<horizon;i++) days.push(toISODate(addDays(new Date(focus), i)));

      const leaveSug = [];
      state.persons.forEach(p=>{
        const scored = days.map(d=>{
          const dayEvents = listDayEvents(d);
          const hasGuard = dayEvents.some(ev=> ev.personId===p.id && TYPE_META[ev.type]?.kind==="guard");
          const hasLeave = dayEvents.some(ev=> ev.personId===p.id && ev.type==="leave");
          const hasHalf = dayEvents.some(ev=> ev.personId===p.id && TYPE_META[ev.type]?.kind==="half");
          const hasRecup = dayEvents.some(ev=> ev.personId===p.id && ev.type==="recup");
          const tomorrowHasGuard = listDayEvents(toISODate(addDays(new Date(d),1))).some(ev=> ev.personId===p.id && TYPE_META[ev.type]?.kind==="guard");
          const yesterdayHasGuard = listDayEvents(toISODate(addDays(new Date(d),-1))).some(ev=> ev.personId===p.id && TYPE_META[ev.type]?.kind==="guard");

          // If already occupied by guard/leave, skip
          if(hasGuard || hasLeave) return { d, score: -999 };

          let score = 0;
          if(hasRecup) score += 3;                 // day is already recup -> nice to chain? (or suggest adjacent)
          if(listDayEvents(toISODate(addDays(new Date(d),-1))).some(ev=> ev.personId===p.id && ev.type==="recup")) score += 2;
          if(listDayEvents(toISODate(addDays(new Date(d),+1))).some(ev=> ev.personId===p.id && ev.type==="recup")) score += 2;

          if(tomorrowHasGuard) score -= 4;          // avoid "veille de garde"
          if(yesterdayHasGuard) score -= 2;         // avoid "retour de garde imm√©diat"
          if(hasHalf) score += 1;                   // half-day -> easy to extend
          // Holidays: you may prefer not to propose leave on holidays (already off) -> score -1
          if(dayEvents.some(ev=>ev.type==="holiday")) score -= 1;

          return { d, score };
        }).filter(x=>x.score>-100).sort((a,b)=> b.score-a.score || a.d.localeCompare(b.d)).slice(0,3);

        if(scored.length){
          leaveSug.push({ person: p.label, picks: scored });
        }
      });

      // guard candidates for focus date: those with least guard count in window
      const disp = buildDisplayEvents();
      const dayGuards = disp.filter(ev=> overlapsDay(ev, focus) && TYPE_META[ev.type]?.kind==="guard");
      const occupied = new Set(dayGuards.map(ev=>ev.personId).filter(Boolean));

      const guardLoad = new Map(); // personId -> count guards in window
      state.persons.forEach(p=>{
        const count = disp.filter(ev=>{
          if(ev.personId !== p.id) return false;
          if(TYPE_META[ev.type]?.kind!=="guard") return false;
          const s = new Date(ev.start), e = new Date(ev.end);
          return e >= start && s <= addDays(end,1);
        }).length;
        guardLoad.set(p.id, count);
      });

      const candidates = state.persons
        .filter(p=> !occupied.has(p.id))
        .map(p=> ({ label:p.label, load: guardLoad.get(p.id) || 0 }))
        .sort((a,b)=> a.load-b.load || a.label.localeCompare(b.label))
        .slice(0,6);

      // Display
      els.kSugLeave.textContent = leaveSug.length ? `${leaveSug.length} pers.` : "‚Äî";
      els.kSugGuard.textContent = candidates.length ? `${candidates.length} candidats` : "‚Äî";

      let html = `<b>Focus date :</b> ${focus}<br><br>`;
      html += `<b>Proposition cong√©s (14 jours)</b><br>`;
      if(!leaveSug.length){
        html += `<span style="color:var(--muted);">Aucune proposition (fen√™tre trop charg√©e ou pas de personnes).</span><br>`;
      }else{
        leaveSug.slice(0,8).forEach(x=>{
          html += `‚Ä¢ <b>${escapeHtml(x.person)}</b> : ${x.picks.map(p=> `${p.d} (score ${p.score})`).join(" ‚Ä¢ ")}<br>`;
        });
      }
      html += `<br><b>Candidats garde (non assign√©s √† la date focus)</b><br>`;
      if(!candidates.length){
        html += `<span style="color:var(--muted);">Aucun candidat disponible.</span>`;
      }else{
        candidates.forEach(c=>{
          html += `‚Ä¢ ${escapeHtml(c.label)} ‚Äî charge gardes fen√™tre: <b>${c.load}</b><br>`;
        });
      }
      els.suggestBox.innerHTML = html;

      // Open modal for visibility
      openEventModal({ start: focus, end: focus }, null, true);
    }

    /************************************************************
      Import/Export
    *************************************************************/
    function exportJSON(){
      els.ioBox.value = JSON.stringify(state, null, 2);
    }

    function importJSON(){
      const txt = els.ioBox.value.trim();
      if(!txt){ alert("Colle un JSON dans la zone."); return; }
      try{
        const obj = JSON.parse(txt);
        if(!obj || typeof obj !== "object") throw new Error("Bad JSON");
        // Minimal validation
        state.persons = Array.isArray(obj.persons) ? obj.persons : [];
        state.events = Array.isArray(obj.events) ? obj.events : [];
        state.viewStart = obj.viewStart ? new Date(obj.viewStart) : startOfMonth(new Date());
        state.settings = obj.settings || state.settings;
        applyTheme();
        applyTogglesFromState();
        save();
        renderAll();
      }catch(e){
        alert("JSON invalide.");
      }
    }

    function exportICS(){
      // Minimal ICS: export only guards (G1/G2) & leaves
      const disp = buildDisplayEvents();
      const {start, end} = getWindowDates();
      const rows = [];
      rows.push("BEGIN:VCALENDAR");
      rows.push("VERSION:2.0");
      rows.push("PRODID:-//GardesConsole//FR");

      disp.forEach(ev=>{
        const kind = TYPE_META[ev.type]?.kind;
        if(!(kind==="guard" || kind==="leave" || kind==="half")) return;
        const s = new Date(ev.start);
        const e = new Date(ev.end);

        // keep within window
        if(e < start || s > end) return;

        const meta = TYPE_META[ev.type] || {label: ev.type};
        const p = ev.personId ? personById(ev.personId) : null;
        const summary = `${meta.label}${p ? " - "+p.label : ""}`;
        const uid = ev.id + "@gardesconsole";

        // all-day event: DTSTART;VALUE=DATE:YYYYMMDD
        const dtS = ev.start.replaceAll("-","");
        // end is exclusive for all-day; ICS requires end date as next day, ok.
        const dtE = ev.end.replaceAll("-","");

        rows.push("BEGIN:VEVENT");
        rows.push("UID:"+uid);
        rows.push("DTSTAMP:"+toICSStamp(new Date()));
        rows.push("DTSTART;VALUE=DATE:"+dtS);
        rows.push("DTEND;VALUE=DATE:"+dtE);
        rows.push("SUMMARY:"+escapeICS(summary));
        if(ev.note) rows.push("DESCRIPTION:"+escapeICS(ev.note));
        rows.push("END:VEVENT");
      });

      rows.push("END:VCALENDAR");

      const ics = rows.join("\r\n");
      els.ioBox.value = ics;
      // Also download
      const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "gardes_export.ics";
      a.click();
      URL.revokeObjectURL(url);
    }

    function toICSStamp(d){
      // UTC stamp: YYYYMMDDTHHMMSSZ
      const dt = new Date(d);
      return dt.getUTCFullYear()
        + pad2(dt.getUTCMonth()+1)
        + pad2(dt.getUTCDate()) + "T"
        + pad2(dt.getUTCHours())
        + pad2(dt.getUTCMinutes())
        + pad2(dt.getUTCSeconds()) + "Z";
    }

    function escapeICS(s){
      return String(s).replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
    }

    /************************************************************
      View switching
    *************************************************************/
    function setView(name){
      document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
      if(name==="cal") document.getElementById("viewCal").classList.add("active");
      if(name==="time") document.getElementById("viewTime").classList.add("active");
      if(name==="cover") document.getElementById("viewCover").classList.add("active");
    }

    /************************************************************
      Misc
    *************************************************************/
    function escapeHtml(s){
      return String(s||"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    /************************************************************
      Wire up events
    *************************************************************/
    function bindUI(){
      els.btnSavePerson.addEventListener("click", savePerson);
      els.btnAddPerson.addEventListener("click", ()=>{ els.pLabel.focus(); });

      els.btnAddEvent.addEventListener("click", ()=> openEventModal());
      els.btnCloseModal.addEventListener("click", closeModal);
      els.modalBack.addEventListener("click", (e)=>{ if(e.target===els.modalBack) closeModal(); });

      els.btnSaveEvent.addEventListener("click", saveEventFromModal);
      els.btnDeleteEvent.addEventListener("click", deleteEvent);

      els.btnReset.addEventListener("click", ()=>{
        if(confirm("Tout effacer ? (irr√©versible)")) hardReset();
      });

      els.btnToday.addEventListener("click", goToday);
      els.btnPrev.addEventListener("click", goPrev);
      els.btnNext.addEventListener("click", goNext);

      els.btnExportJSON.addEventListener("click", exportJSON);
      els.btnImportJSON.addEventListener("click", importJSON);
      els.btnExportICS.addEventListener("click", exportICS);

      els.btnTheme.addEventListener("click", ()=>{
        state.settings.theme = (state.settings.theme==="dark") ? "light" : "dark";
        save();
        applyTheme();
      });

      els.tglHolidays.addEventListener("change", ()=>{
        state.settings.showHolidays = els.tglHolidays.checked;
        save();
        renderAll();
      });
      els.tglRecup.addEventListener("change", ()=>{
        state.settings.showRecup = els.tglRecup.checked;
        save();
        renderAll();
      });
      els.tglHalf.addEventListener("change", ()=>{
        state.settings.showHalf = els.tglHalf.checked;
        save();
        renderAll();
      });

      els.btnPropose.addEventListener("click", propose);

      // Keyboard: ESC closes modal
      window.addEventListener("keydown", (e)=>{
        if(e.key==="Escape") closeModal();
      });
    }

    /************************************************************
      Init
    *************************************************************/
    function init(){
      cacheEls();
      bindUI();

      const ok = load();
      if(!ok){
        // minimal seed: none. Because you asked: NO pre-registered names.
        save();
      }else{
        // normalize viewStart if stored as string
        state.viewStart = new Date(state.viewStart);
      }

      applyTogglesFromState();
      applyTheme();
      renderAll();

      // If no persons, open hint via modal? Keep calm: no.
    }

    init();
  </script>
</body>
</html>
